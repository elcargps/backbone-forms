Form.editors.List=Form.editors.Base.extend({events:{'click [data-action="add"]':function(e){e.preventDefault(),this.addItem(undefined,!0)}},initialize:function(e){e=e||{};var t=Form.editors;t.Base.prototype.initialize.call(this,e);var n=this.schema;if(!n)throw new Error("Missing required option 'schema'");this.schema=_.extend({addLabel:"Add"},n),this.template=e.template||n.listTemplate||this.constructor.template,this.Editor=function(){var e=n.itemType;return e?t.List[e]?t.List[e]:_.isString(e)?t[e]:e:t.Text}(),this.ListItem=n.itemClass||t.List.Item,this.items=[]},render:function(){var e=this,t=this.value||[],n=Backbone.$,r=n(n.trim(this.template({addLabel:this.schema.addLabel})));return this.$list=r.is("[data-items]")?r:r.find("[data-items]"),t instanceof Backbone.Collection&&(t=t.toJSON()),t.length?_.each(t,function(n){e.addItem(n)}):this.Editor.isAsync||this.addItem(),this._checkMaxCardinalityReached(r),this.setElement(r),this.$el.attr("id",this.id),this.$el.attr("name",this.key),this.hasFocus&&this.trigger("blur",this),this},_checkMaxCardinalityReached:function(e){this.schema.maxListLength&&this.items.length>=this.schema.maxListLength&&e.find('button[data-action="add"]').hide()},addItem:function(e,t){var n=this,r=Form.editors,i=(new this.ListItem({list:this,form:this.form,schema:this.schema,value:e,Editor:this.Editor,key:this.key})).render(),s=function(){n.items.push(i),n.$list.append(i.el),n._checkMaxCardinalityReached(n.$el),i.editor.on("all",function(e){if(e==="change")return;var t=_.toArray(arguments);t[0]="item:"+e,t.splice(1,0,n),r.List.prototype.trigger.apply(this,t)},n),i.editor.on("change",function(){i.addEventTriggered||(i.addEventTriggered=!0,this.trigger("add",this,i.editor)),this.trigger("item:change",this,i.editor),this.trigger("change",this)},n),i.editor.on("focus",function(){if(this.hasFocus)return;this.trigger("focus",this)},n),i.editor.on("blur",function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(_.find(e.items,function(e){return e.editor.hasFocus}))return;e.trigger("blur",e)},0)},n);if(t||e)i.addEventTriggered=!0;t&&(n.trigger("add",n,i.editor),n.trigger("change",n))};return this.Editor.isAsync?i.editor.on("readyToAdd",s,this):(s(),i.editor.focus()),i},removeItem:function(e){var t=this.schema.confirmDelete;if(t&&!confirm(t))return;var n=_.indexOf(this.items,e);this.items[n].remove(),this.items.splice(n,1),e.addEventTriggered&&(this.trigger("remove",this,e.editor),this.trigger("change",this)),!this.items.length&&!this.Editor.isAsync&&this.addItem(),this.schema.maxListLength&&this.items.length<this.schema.maxListLength&&this.$el.find('button[data-action="add"]').show()},getValue:function(){var e=_.map(this.items,function(e){return e.getValue()});return _.without(e,undefined,"")},setValue:function(e){this.value=e,this.render()},focus:function(){if(this.hasFocus)return;this.items[0]&&this.items[0].editor.focus()},blur:function(){if(!this.hasFocus)return;var e=_.find(this.items,function(e){return e.editor.hasFocus});e&&e.editor.blur()},remove:function(){_.invoke(this.items,"remove"),Form.editors.Base.prototype.remove.call(this)},validate:function(){var e=_.map(this.items,function(e){return e.validate()}),t=_.compact(e).length?!0:!1;if(!t)return null;var n={type:"list",message:"Some of the items in the list failed validation",errors:e};return n}},{template:_.template('    <div>      <div data-items></div>      <button type="button" data-action="add"><%= addLabel %></button>    </div>  ',null,Form.templateSettings)}),Form.editors.List.Item=Form.editors.Base.extend({events:{'click [data-action="remove"]':function(e){e.preventDefault(),this.list.removeItem(this)},"keydown input[type=text]":function(e){if(e.keyCode!==13)return;e.preventDefault(),this.list.addItem(),this.list.$list.find("> li:last input").focus()}},initialize:function(e){this.list=e.list,this.schema=e.schema||this.list.schema,this.value=e.value,this.Editor=e.Editor||Form.editors.Text,this.key=e.key,this.template=e.template||this.schema.itemTemplate||this.constructor.template,this.errorClassName=e.errorClassName||this.constructor.errorClassName,this.form=e.form},render:function(){var e=Backbone.$;this.editor=(new this.Editor({key:this.key,schema:this.schema,value:this.value,list:this.list,item:this,form:this.form})).render();var t=e(e.trim(this.template()));return t.find("[data-editor]").append(this.editor.el),this.setElement(t),this},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove(),Backbone.View.prototype.remove.call(this)},validate:function(){var e=this.getValue(),t=this.list.form?this.list.form.getValue():{},n=this.schema.validators,r=this.getValidator;if(this.editor.nestedForm&&this.editor.nestedForm.validate)return this.editor.nestedForm.validate();if(!n)return null;var i=null;return _.every(n,function(n){return i=r(n)(e,t),i?!1:!0}),i?this.setError(i):this.clearError(),i?i:null},setError:function(e){this.$el.addClass(this.errorClassName),this.$el.attr("title",e.message)},clearError:function(){this.$el.removeClass(this.errorClassName),this.$el.attr("title",null)}},{template:_.template('    <div>      <span data-editor></span>      <button type="button" data-action="remove">&times;</button>    </div>  ',null,Form.templateSettings),errorClassName:"error"}),Form.editors.List.Modal=Form.editors.Base.extend({events:{click:"openEditor"},initialize:function(e){e=e||{},Form.editors.Base.prototype.initialize.call(this,e);if(!Form.editors.List.Modal.ModalAdapter)throw new Error("A ModalAdapter is required");this.form=e.form;if(!e.form)throw new Error('Missing required option: "form"');this.template=e.template||this.constructor.template},render:function(){var e=this;return _.isEmpty(this.value)?this.openEditor():(this.renderSummary(),setTimeout(function(){e.trigger("readyToAdd")},0)),this.hasFocus&&this.trigger("blur",this),this},renderSummary:function(){this.$el.html($.trim(this.template({summary:this.getStringValue()})))},itemToString:function(e){var t=function(e){var t={key:e};return Form.Field.prototype.createTitle.call(t)};e=e||{};var n=[];return _.each(this.nestedSchema,function(r,i){var s=r.title?r.title:t(i),o=e[i];if(_.isUndefined(o)||_.isNull(o))o="";n.push(s+": "+o)}),n.join("<br />")},getStringValue:function(){var e=this.schema,t=this.getValue();return _.isEmpty(t)?"[Empty]":e.itemToString?e.itemToString(t):this.itemToString(t)},openEditor:function(){var e=this,t=this.form.constructor,n=this.modalForm=new t({schema:this.nestedSchema,data:this.value}),r=this.modal=new Form.editors.List.Modal.ModalAdapter({content:n,animate:!0});r.open(),this.trigger("open",this),this.trigger("focus",this),r.on("cancel",this.onModalClosed,this),r.on("ok",_.bind(this.onModalSubmitted,this))},onModalSubmitted:function(){var e=this.modal,t=this.modalForm,n=!this.value,r=t.validate();if(r)return e.preventClose();this.value=t.getValue(),this.renderSummary(),n&&this.trigger("readyToAdd"),this.trigger("change",this),this.onModalClosed()},onModalClosed:function(){this.modal=null,this.modalForm=null,this.trigger("close",this),this.trigger("blur",this)},getValue:function(){return this.value},setValue:function(e){this.value=e},focus:function(){if(this.hasFocus)return;this.openEditor()},blur:function(){if(!this.hasFocus)return;this.modal&&this.modal.trigger("cancel")}},{template:_.template("    <div><%= summary %></div>  ",null,Form.templateSettings),ModalAdapter:Backbone.BootstrapModal,isAsync:!0}),Form.editors.List.Object=Form.editors.List.Modal.extend({initialize:function(){Form.editors.List.Modal.prototype.initialize.apply(this,arguments);var e=this.schema;if(!e.subSchema)throw new Error('Missing required option "schema.subSchema"');this.nestedSchema=e.subSchema}}),Form.editors.List.NestedModel=Form.editors.List.Modal.extend({initialize:function(){Form.editors.List.Modal.prototype.initialize.apply(this,arguments);var e=this.schema;if(!e.model)throw new Error('Missing required option "schema.model"');var t=e.model.prototype.schema;this.nestedSchema=_.isFunction(t)?t():t},getStringValue:function(){var e=this.schema,t=this.getValue();return _.isEmpty(t)?null:e.itemToString?e.itemToString(t):(new e.model(t)).toString()}})